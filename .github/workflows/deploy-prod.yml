name: Deploy Prod

on:
  push:
    tags:
      - "v*"

jobs:
  tests:
    uses: ./.github/workflows/tests.yml

  build:
    uses: ./.github/workflows/build.yml
    with:
      tag: ${{ github.ref_name }}

  deploy:
    runs-on: ubuntu-latest

    environment: production

    needs:
      - tests
      - build

    steps:
      - name: Update Image
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: docker pull ghcr.io/liquidcats/ishabanov.com:${{ github.ref_name }}

      - name: Update Image
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            BUILD_VERION=${{ github.ref_name }} \
              docker stack deploy \
                --with-registry-auth \
                --compose-file ~/deploy/ishabanov/docker-compose.prod.yml \
                ishabanov_prod
